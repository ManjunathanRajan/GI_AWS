name: Build Linux AMI with Packer

on:
  workflow_dispatch: {}

env:
  AWS_REGION: us-west-2
  PRODUCT_VERSION: "1.8.6"
  DOCKER_IMAGE: 716514200744.dkr.ecr.us-west-2.amazonaws.com/packer-awsal2023:latest

jobs:
  build-linux-ami:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      issues: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install --update
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Set up Packer
      uses: hashicorp/setup-packer@v2.0.0
      id: setup
      with:
        version: ${{ env.PRODUCT_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.IAMROLE_GITHUB }}
        role-session-name: GitHub-Action-Role
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      run: |
        ECR_REGISTRY=$(echo ${{ env.DOCKER_IMAGE }} | cut -d'/' -f1)
        aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY

    - name: Pull Docker image from ECR
      run: docker pull ${{ env.DOCKER_IMAGE }}

    - name: Validate and Build Linux AMI
      run: |
        packer validate packer-linux-ami.json
        packer build packer-linux-ami.json
