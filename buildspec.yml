version: 0.2

phases:
  install:
    commands:
      - echo "Installing Packer..."
      - curl -o packer.zip https://releases.hashicorp.com/packer/1.7.8/packer_1.7.8_linux_amd64.zip
      - unzip packer.zip
      - rm -f packer.zip
      - chmod +x packer
      - sudo mv packer /usr/local/bin

  pre_build:
    commands:
      - echo "Setting up Git authentication using PAT..."
      - yum update -y && yum install -y python
      - SECRET_VALUE=$(aws secretsmanager get-secret-value --secret-id arn:aws:secretsmanager:us-west-2:716514200744:secret:pat_gh-b7FRfI --query SecretString --output json)
      - GITHUB_PAT=$(echo $SECRET_VALUE | python -c "import sys, json; print(json.loads(json.load(sys.stdin))['PAT'])")
      - echo "Setting environment variable for Git authentication..."
      - export GIT_ASKPASS=$(pwd)/git-askpass.sh
      - echo -e '#!/bin/sh\necho $GITHUB_PAT' > $GIT_ASKPASS
      - chmod +x $GIT_ASKPASS
      - echo "Cloning the repository using PAT..."
      - git clone https://github.com/ManjunathanRajan/golden-image-windows.git
      - echo "Changing the working directory to the cloned repository..."
      - cd golden-image-windows
      - echo "Setting Git user name and email for this repository..."
      - git config user.email "manjun566@gmail.com"
      - git config user.name "ManjunathanRajan"
      - echo "Pulling the latest changes from the main branch..."
      - git checkout main
      - git pull origin main
      - echo "Fetching the latest tag and incrementing the tag number..."
      - LATEST_TAG=$(git describe --tags --abbrev=0)
      - NEW_TAG_NUMBER=$((10#${LATEST_TAG:3} + 1))
      - NEW_TAG="GA-$(printf "%02d" $NEW_TAG_NUMBER)"
      - TAG_MESSAGE="Release $NEW_TAG"
      - echo "Creating a new tag..."
      - git tag $NEW_TAG -m "$TAG_MESSAGE"
      - echo "Pushing the new tag to the original GitHub repository..."
      - git push origin $NEW_TAG
      - echo "Creating a release on GitHub..."
      - RELEASE_TITLE="Golden Image Windows Server 2019 - $NEW_TAG"
      - RELEASE_DESCRIPTION="This is the release for Golden Image Windows Server 2019 - $NEW_TAG. This release includes the latest updates and improvements.\\n\\nAdditional information:\\n- Feature 1\\n- Feature 2\\n- Bugfixes"
      - curl -X POST -H "Authorization: token $GITHUB_PAT" -H "Content-Type: application/json" -d "{\"tag_name\":\"$NEW_TAG\",\"target_commitish\":\"main\",\"name\":\"$RELEASE_TITLE\",\"body\":\"$RELEASE_DESCRIPTION\"}" https://api.github.com/repos/ManjunathanRajan/golden-image-windows/releases

  build:
    commands:
      - echo "Building Windows Packer AMI..."
      - packer validate packer-windows-ami.json
      - packer build packer-windows-ami.json
      - packer build -var "ami_tag=$NEW_TAG" packer-windows-ami.json

artifacts:
  files:
    - '**/*'
